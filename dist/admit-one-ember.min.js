!function(){"use strict";var t={},e={},n={};t.Base=Ember.Object.extend(Ember.Evented,{persist:function(){throw new Error("implement persist")},restore:function(){throw new Error("implement restore")},clear:function(){throw new Error("implement clear")}}),t.Local=t.Base.extend({init:function(){this._super(),this._watchStorage()},persist:function(t){localStorage.setItem("auth-data",JSON.stringify(t))},restore:function(){return JSON.parse(localStorage.getItem("auth-data"))},clear:function(){localStorage.removeItem("auth-data")},_watchStorage:function(){Ember.$(window).on("storage",function(){this.trigger("change")}.bind(this))}}),e.Base=Ember.Object.extend({authenticate:function(){return Ember.RSVP.reject("implement authenticate")},invalidate:function(){return Ember.RSVP.resolve()}}),n.Base=Ember.Object.extend({session:function(){return this.container.lookup("auth-session:main")}.property(),authorize:function(){},capturedAuthorization:void 0});var i=Ember.ObjectProxy.extend({attemptedTransition:null,content:{},init:function(){this._super(),this._installPrefilter()},storage:function(){var t=this.container.lookup("auth-session-settings:main");return this.container.lookup(t.storage)}.property(),authenticator:function(){var t=this.container.lookup("auth-session-settings:main");return this.container.lookup(t.authenticator)}.property(),authorizer:function(){var t=this.container.lookup("auth-session-settings:main");return this.container.lookup(t.authorizer)}.property(),isAuthenticated:function(){return Ember.keys(this.get("content")).length>0}.property("content"),authenticate:function(t){return this.get("authenticator").authenticate(t).then(function(t){return this.set("content",t),t}.bind(this))},login:function(t){var e=this.get("authorizer"),n=e.get("capturedAuthorization");if(!n)throw new Error("Authorization information not captured by authorizer.");this.set("content",Ember.$.extend({},t,n))},invalidate:function(){var t=function(){this.set("content",{}),this.get("authenticator").set("capturedAuthorization",void 0),this.get("storage").clear()}.bind(this);return this.get("authenticator").invalidate(this.get("content")).then(t,function(e){throw t(),e})},integrateContent:function(t){this.get("isAuthenticated")&&this.set("content",Ember.$.extend({},t,this.get("content")))},restore:function(){var t=this.get("storage"),e=t.restore()||{};this.set("content",e)},observeStorage:function(){var t=this.get("storage");t.off("change",this,this.restore),t.on("change",this,this.restore)},_contentChanged:function(){this.get("storage").persist(this.get("content"))}.observes("content"),_installPrefilter:function(){Ember.$.ajaxPrefilter(function(t,e,n){this.isDestroyed||t.crossDomain||this.get("authorizer").authorize(n,t)}.bind(this))}}),r=Ember.Mixin.create({beforeModel:function(t){this._super(),this.get("session").get("isAuthenticated")||(this.get("session").set("attemptedTransition",t),this.transitionTo("login"))}}),o=function(r,o,s){var a=Ember.$.extend({},{authenticator:"auth-session-authenticator:base",authorizer:"auth-session-authorizer:base",storage:"auth-session-storage:local"},s);o.register("auth-session-settings:main",a,{instantiate:!1}),o.register("auth-session:main",i),o.register("auth-session-authenticator:base",e),o.register("auth-session-authorizer:base",n),o.register("auth-session-storage:local",t.Local),o.inject("controller","session","auth-session:main"),o.inject("route","session","auth-session:main");var u=r.lookup("auth-session:main");u.restore(),u.observeStorage()};Ember.TinyAuth={setup:o,Storage:t,Authenticator:e,Authorizer:n,AuthenticatedRouteMixin:r}}(),function(){"use strict";var t=Ember.TinyAuth,e=Ember.AdmitOne=Ember.AdmitOne||{};Ember.$.extend(e,t);var n=function(t){var e=t.getResponseHeader("Authorization"),n=e&&e.match(/\s*token\s+(.*)\s*/i),i=n&&n[1],r=e&&!!e.match(/\s*invalidated\s*/i);return[i,r]};e.Authenticator=t.Authenticator.Base.extend({authenticate:function(t){var e=this.container.lookup("admit-one-settings:main"),i=e.api.authenticate;return new Ember.RSVP.Promise(function(e,r){Ember.$.ajax(i,{method:"post",contentType:"application/json; charset=utf-8",data:JSON.stringify({session:t})}).then(function(t,i,r){var o=n(r),s=o[0];e(Ember.$.extend({},t.session,{token:s}))},function(t,e,n){r(n)})})},invalidate:function(){var t=this.container.lookup("admit-one-settings:main"),e=t.api.invalidate;return new Ember.RSVP.Promise(function(t,n){Ember.$.ajax(e,{method:"delete",contentType:"application/json; charset=utf-8"}).then(function(){t()},function(t,e,i){n(i)})})}}),e.Authorizer=t.Authorizer.Base.extend(Ember.Evented,{authorize:function(t,e){var i=this.get("session"),r=i.get("token");r&&(e.beforeSend=function(t){return function(e){return e.setRequestHeader("Authorization","Token "+r),t.apply(this,arguments)}}(e.beforeSend||function(){})),e.success=e.success||[],e.success=Ember.$.isArray(e.success)?e.success:[e.success],e.success.unshift(function(t,e,r){var o=n(r),s=o[0],a=o[1];a?i.invalidate():s&&(this.trigger("authorization-token",s),this.set("capturedAuthorization",{token:s}),i.integrateContent({token:s}))}.bind(this))}})}(),function(){Ember.AdmitOne.setup=function(t){var e=t||{};e.containers=Ember.$.extend(e.containers||{},{authenticator:"auth-session-authenticator:admit-one",authorizer:"auth-session-authorizer:admit-one",storage:"auth-session-storage:local"}),"string"===Ember.typeOf(e.api)&&(e.api={endpoint:e.api}),e.api=e.api||{},e.api.endpoint=e.api.endpoint||"/api",e.api.authenticate=e.api.authenticate||e.api.endpoint+"/sessions",e.api.invalidate=e.api.invalidate||e.api.endpoint+"/sessions/current",Ember.Application.initializer({name:"admit-one",initialize:function(t,n){var i=Ember.AdmitOne,r=i.Authenticator,o=i.Authorizer;n.register("auth-session-authenticator:admit-one",r),n.register("auth-session-authorizer:admit-one",o),n.register("admit-one-settings:main",e,{instantiate:!1}),Ember.TinyAuth.setup(t,n,e.containers)}})}}();